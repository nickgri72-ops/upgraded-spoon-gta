<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mini GTA - iPad</title>
<style>
  body{margin:0;overflow:hidden;background:#111;color:#fff;font-family:monospace}
  #hud{position:fixed;top:8px;left:8px;z-index:10}
  #hud div{margin:2px 0}
  .btn{position:fixed;bottom:18px;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:20px;z-index:10}
  #left{left:18px} #right{left:90px} #up{left:54px;bottom:86px} #down{left:54px}
  #shoot{right:18px;bottom:18px;width:70px;height:70px}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hud">
  <div>WANTED: <span id="wanted">0</span></div>
  <div>KILLS: <span id="kills">0</span></div>
  <div>MISSION: <span id="mission">Steal 1 car</span></div>
</div>
<div id="left" class="btn">◀</div>
<div id="right" class="btn">▶</div>
<div id="up" class="btn">▲</div>
<div id="down" class="btn">▼</div>
<div id="shoot" class="btn">●</div>

<script>
const c=document.getElementById("c"),x=c.getContext("2d");
let W=innerWidth,H=innerHeight;
c.width=W;c.height=H;
window.addEventListener("resize",()=>{W=innerWidth;H=innerHeight;c.width=W;c.height=H;});

let keys={};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

const touchBtns = {
  left:false,right:false,up:false,down:false,shoot:false
};

["left","right","up","down","shoot"].forEach(id=>{
  document.getElementById(id).addEventListener("touchstart",e=>{e.preventDefault();touchBtns[id]=true;});
  document.getElementById(id).addEventListener("touchend",e=>{e.preventDefault();touchBtns[id]=false;});
});

let world={w:2000,h:2000};
let cam={x:0,y:0};

function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

let player={
  x:world.w/2, y:world.h/2,
  w:28,h:16, speed:3,
  dir:0
};

let wanted=0,kills=0;

let npcs=[];
for(let i=0;i<35;i++){
  npcs.push({
    x:Math.random()*world.w,
    y:Math.random()*world.h,
    dx:(Math.random()-0.5)*1.2,
    dy:(Math.random()-0.5)*1.2,
    type:"npc",
    alive:true
  });
}

let police=[];
function spawnPolice(){
  police.push({
    x:Math.random()*world.w,
    y:Math.random()*world.h,
    dx:0,dy:0,
    speed:2.4,
    alive:true
  });
}

let bullets=[];
function shoot(){
  bullets.push({
    x:player.x+player.w/2,
    y:player.y+player.h/2,
    dx:Math.cos(player.dir)*7,
    dy:Math.sin(player.dir)*7
  });
}

let missions = [
  {text:"Steal 1 car",done:false,goal:1,progress:0},
  {text:"Eliminate 3 NPCs",done:false,goal:3,progress:0},
  {text:"Evade police 15s",done:false,goal:15,progress:0}
];
let currentMission=0;
let policeTimer=0;

function update(){
  // movement
  let moveX=0, moveY=0;
  if(keys["ArrowLeft"]||keys["a"]||touchBtns.left) moveX=-1;
  if(keys["ArrowRight"]||keys["d"]||touchBtns.right) moveX=1;
  if(keys["ArrowUp"]||keys["w"]||touchBtns.up) moveY=-1;
  if(keys["ArrowDown"]||keys["s"]||touchBtns.down) moveY=1;

  if(moveX||moveY){
    player.dir=Math.atan2(moveY,moveX);
    player.x += moveX*player.speed;
    player.y += moveY*player.speed;
  }

  player.x=clamp(player.x,0,world.w-player.w);
  player.y=clamp(player.y,0,world.h-player.h);

  // shooting
  if((keys[" "]||touchBtns.shoot) && bullets.length<5){
    shoot();
  }

  // camera follow
  cam.x=player.x-W/2;
  cam.y=player.y-H/2;
  cam.x=clamp(cam.x,0,world.w-W);
  cam.y=clamp(cam.y,0,world.h-H);

  // NPCs
  npcs.forEach(n=>{
    if(!n.alive) return;
    n.x+=n.dx; n.y+=n.dy;
    if(n.x<0||n.x>world.w) n.dx*=-1;
    if(n.y<0||n.y>world.h) n.dy*=-1;
  });

  // bullets
  bullets=bBullets(bullets);

  // police behavior
  if(wanted>0){
    policeTimer+=1/60;
    if(policeTimer>3){spawnPolice();policeTimer=0;}
  }
  police.forEach(p=>{
    let dx=player.x-p.x, dy=player.y-p.y;
    let dist=Math.hypot(dx,dy);
    if(dist>1){
      p.x += (dx/dist)*p.speed;
      p.y += (dy/dist)*p.speed;
    }
    if(dist<18){
      wanted=0;
      police=[];
      missions[currentMission].progress=0;
    }
  });

  // collisions
  npcs.forEach(n=>{
    if(!n.alive) return;
    if(collide(player,n)){
      wanted=Math.min(5,wanted+1);
    }
  });

  bullets.forEach(b=>{
    npcs.forEach(n=>{
      if(!n.alive) return;
      if(collidePointRect(b.x,b.y,n)){
        n.alive=false;
        kills++;
        wanted=Math.min(5,wanted+1);
        missions[1].progress++;
      }
    });
  });

  // missions
  let m=missions[currentMission];
  if(currentMission==0){
    npcs.forEach(n=>{
      if(!n.alive) return;
      if(collide(player,n)){
        n.alive=false;
        m.progress++;
        wanted=Math.min(5,wanted+1);
      }
    });
  } else if(currentMission==2){
    if(wanted==0 && police.length==0){
      m.progress += 1/60;
    } else {
      m.progress=0;
    }
  }

  if(m.progress>=m.goal){
    m.done=true;
    currentMission++;
    if(currentMission>=missions.length) currentMission=missions.length-1;
  }
}

function bBullets(arr){
  return arr.map(b=>{
    b.x+=b.dx; b.y+=b.dy;
    return b;
  }).filter(b=>b.x>0 && b.x<W && b.y>0 && b.y<H);
}

function collide(a,b){
  return !(a.x+a.w<b.x||a.x>b.x+10||a.y+a.h<b.y||a.y>b.y+10);
}
function collidePointRect(px,py,r){
  return px>=r.x && px<=r.x+10 && py>=r.y && py<=r.y+10;
}

function draw(){
  x.fillStyle="#222"; x.fillRect(0,0,W,H);

  // background grid
  x.strokeStyle="#333"; x.lineWidth=1;
  for(let gx=0;gx<world.w;gx+=100){
    x.beginPath(); x.moveTo(gx-cam.x,0); x.lineTo(gx-cam.x,H); x.stroke();
  }
  for(let gy=0;gy<world.h;gy+=100){
    x.beginPath(); x.moveTo(0,gy-cam.y); x.lineTo(W,gy-cam.y); x.stroke();
  }

  // roads
  x.fillStyle="#444";
  x.fillRect(-cam.x,world.h/2-20-cam.y,world.w,40);
  x.fillRect(world.w/2-20-cam.x,-cam.y,40,world.h);

  // NPCs
  npcs.forEach(n=>{
    if(!n.alive) return;
    x.fillStyle="yellow";
    x.beginPath();
    x.arc(n.x-cam.x,n.y-cam.y,6,0,Math.PI*2);
    x.fill();
  });

  // police
  police.forEach(p=>{
    x.fillStyle="blue";
    x.beginPath();
    x.arc(p.x-cam.x,p.y-cam.y,8,0,Math.PI*2);
    x.fill();
  });

  // player
  x.fillStyle="red";
  x.save();
  x.translate(player.x-cam.x+player.w/2,player.y-cam.y+player.h/2);
  x.rotate(player.dir);
  x.fillRect(-player.w/2,-player.h/2,player.w,player.h);
  x.restore();

  // bullets
  x.fillStyle="white";
  bullets.forEach(b=>{
    x.fillRect(b.x-cam.x,b.y-cam.y,4,4);
  });

  // HUD
  document.getElementById("wanted").innerText=wanted;
  document.getElementById("kills").innerText=kills;
  document.getElementById("mission").innerText=missions[currentMission].text + " (" + Math.floor(missions[currentMission].progress) + "/" + missions[currentMission].goal + ")";
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
